<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BarbaPRO ðŸ’ˆ</title>
  <meta name="theme-color" content="#00ff88" />
  <!-- PWA: vira app na tela inicial -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\":\"BarbaPRO\",
    \"short_name\":\"Barba\",
    \"icons\":[{\"src\":\"https://cdn-icons-png.flaticon.com/512/1815/1815465.png\",\"sizes\":\"192x192\"}],
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#0a0a0a\",
    \"theme_color\":\"#00ff88\"
  }" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap');
    
    * { 
      margin:0; 
      padding:0; 
      box-sizing:border-box; 
      -webkit-tap-highlight-color:transparent; 
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      touch-action: manipulation;
      line-height: 1.6;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-family: 'Bebas Neue', cursive;
      font-size: 15vw;
      text-align: center;
      background: linear-gradient(45deg, #00ff88, #00cc77);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 20px 0 10px;
      text-shadow: 0 0 30px rgba(0,255,136,0.4);
      letter-spacing: 2px;
    }
    
    .subtitle {
      color: #aaa;
      font-size: 4.5vw;
      margin-bottom: 20px;
    }
    
    .card {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 24px;
      margin: 16px 0;
      box-shadow: 0 8px 32px rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,255,136,0.15);
    }
    
    .btn {
      width: 100%;
      padding: 20px;
      margin: 12px 0;
      border: none;
      border-radius: 16px;
      font-size: 5.5vw;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    
    .corte   { 
      background: linear-gradient(45deg, #00ff88, #00cc77); 
      color: #000; 
    }
    
    .outro   { 
      background: linear-gradient(45deg, #ffaa33, #ff7733); 
      color: #fff; 
    }
    
    .resumo  { 
      background: linear-gradient(45deg, #3366ff, #0033cc); 
      color: #fff; 
    }
    
    .expediente {
      background: linear-gradient(45deg, #9933ff, #6600cc);
      color: #fff;
    }
    
    .abrir-expediente {
      background: linear-gradient(45deg, #00cc77, #009944);
      color: #fff;
    }
    
    .secundario {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    
    .btn:active { 
      transform: scale(0.96); 
    }
    
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,255,255,0.4);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }
    
    @keyframes ripple { 
      to { 
        transform: scale(4); 
        opacity: 0; 
      } 
    }

    input, select {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      border: none;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 5vw;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #00ff88;
      box-shadow: 0 0 0 2px rgba(0,255,136,0.2);
    }
    
    input::placeholder { 
      color: #aaa; 
    }

    table { 
      width:100%; 
      border-collapse:collapse; 
      margin:20px 0; 
      font-size: 3.8vw;
    }
    
    th, td { 
      border:1px solid #00ff8830; 
      padding:10px; 
      text-align:center; 
      position:relative; 
    }
    
    th { 
      background: rgba(0,255,136,0.15); 
      font-weight:700; 
      font-size: 4vw;
    }
    
    .pago  { 
      background: rgba(0,200,0,0.2); 
    }
    
    .fiado { 
      background: rgba(200,0,0,0.2); 
    }
    
    .action-btn {
      background: #3366ff;
      color: white;
      border: none;
      border-radius: 6px;
      width: 28px; 
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 2px;
    }
    
    .edit-btn {
      background: #ffaa33;
    }
    
    .delete-btn {
      background: #ff3366;
    }
    
    #resumo {
      font-size: 5vw;
      line-height: 1.6;
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 16px;
      margin-top: 20px;
    }
    
    .lucro { 
      font-size: 7vw; 
      font-weight: 900; 
      color: #00ff88; 
      margin-top: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 6vw;
      font-weight: 800;
      margin: 5px 0;
    }
    
    .stat-label {
      font-size: 3.5vw;
      color: #aaa;
    }
    
    .hoje { color: #00ff88; }
    .mes { color: #3366ff; }
    .semana { color: #ffaa33; }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    
    .section-title {
      font-size: 6vw;
      margin: 25px 0 15px;
      color: #00ff88;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title::after {
      content: '';
      flex: 1;
      height: 2px;
      background: linear-gradient(90deg, #00ff88, transparent);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-content {
      background: rgba(30,30,30,0.95);
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 7vw;
      margin-bottom: 20px;
      text-align: center;
      color: #00ff88;
    }
    
    .expediente-fechado {
      background: rgba(255,50,50,0.2);
      border: 2px solid #ff3366;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin: 15px 0;
    }
    
    .expediente-info {
      font-size: 4.5vw;
      color: #ffaa33;
      margin: 5px 0;
    }
    
    .close-modal {
      background: #ff3366;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 15px;
      width: 100%;
      margin-top: 20px;
      font-weight: 700;
      cursor: pointer;
    }
    
    .backup-status {
      font-size: 4vw;
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
    }
    
    .backup-success {
      background: rgba(0,255,136,0.2);
      color: #00ff88;
    }
    
    .backup-error {
      background: rgba(255,50,50,0.2);
      color: #ff3366;
    }
    
    @media (min-width: 768px) {
      body {
        padding: 30px;
      }
      
      h1 {
        font-size: 80px;
      }
      
      .subtitle {
        font-size: 24px;
      }
      
      .btn {
        font-size: 18px;
        padding: 18px;
      }
      
      input, select {
        font-size: 16px;
        padding: 14px;
      }
      
      table {
        font-size: 14px;
      }
      
      th {
        font-size: 15px;
      }
      
      #resumo {
        font-size: 16px;
      }
      
      .lucro {
        font-size: 32px;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      .stat-label {
        font-size: 14px;
      }
      
      .section-title {
        font-size: 24px;
      }
      
      .modal-title {
        font-size: 28px;
      }
      
      .expediente-info {
        font-size: 16px;
      }
      
      .backup-status {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>BarbaPRO</h1>
      <div class="subtitle">Controle financeiro para barbearias</div>
    </div>

    <!-- STATUS DO EXPEDIENTE -->
    <div id="statusExpediente" class="card" style="display:none">
      <div class="expediente-fechado">
        <h3>EXPEDIENTE FECHADO</h3>
        <div class="expediente-info" id="infoExpediente"></div>
        <button class="btn abrir-expediente" onclick="abrirExpediente()">
          ABRIR EXPEDIENTE
        </button>
      </div>
    </div>

    <!-- BOTÃ•ES PRINCIPAIS -->
    <div class="card" id="botoesPrincipais">
      <button class="btn corte" onclick="cortePadrao()">
        CORTE R$ <span id="valorCorte">20</span>
      </button>
      <button class="btn corte" onclick="editarValorCorte()">
        EDITAR VALOR DO CORTE
      </button>
      <button class="btn outro" onclick="cortePersonalizado()">
        OUTRO VALOR
      </button>
      <button class="btn resumo" onclick="mostrarResumoCompleto()">
        VER RESUMO
      </button>
      <button class="btn expediente" onclick="finalizarExpediente()">
        FECHAR EXPEDIENTE
      </button>
    </div>

    <!-- FORM OUTRO VALOR -->
    <div id="formCorte" class="card" style="display:none">
      <h3 class="section-title">Novo Corte</h3>
      <input id="valorCustom" type="number" placeholder="Valor do corte (ex: 40)" />
      <input id="cliente" placeholder="Nome do cliente (opcional)" />
      <select id="pago">
        <option value="1">PAGO</option>
        <option value="0">FIADO</option>
      </select>
      <button class="btn corte" onclick="salvarCorte()">SALVAR CORTE</button>
      <button class="btn secundario" onclick="cancelar()">CANCELAR</button>
    </div>

    <!-- LISTA DO DIA -->
    <div class="card">
      <h3 class="section-title">Cortes de Hoje</h3>
      <div id="lista"></div>
    </div>

    <!-- RESUMO SIMPLES -->
    <div id="resumo" class="card"></div>

    <!-- STATUS BACKUP -->
    <div id="backupStatus" class="backup-status" style="display:none"></div>
  </div>

  <!-- MODAL RESUMO COMPLETO -->
  <div id="modalResumo" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Resumo Completo</h3>
      <div id="resumoCompleto"></div>
      <button class="close-modal" onclick="fecharModal()">FECHAR</button>
    </div>
  </div>

  <!-- MODAL EDITAR VALOR DO CORTE -->
  <div id="modalEditarValor" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Editar Valor do Corte</h3>
      <input id="novoValorCorte" type="number" placeholder="Novo valor padrÃ£o" value="20" />
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn corte" onclick="salvarNovoValor()" style="flex: 1;">SALVAR</button>
        <button class="btn secundario" onclick="fecharModalEditarValor()" style="flex: 1;">CANCELAR</button>
      </div>
    </div>
  </div>

  <script>
    // === SISTEMA DE BACKUP NO GOOGLE DRIVE ===
    class DriveBackup {
      constructor() {
        this.backupKey = 'barbapro_backup_data';
        this.lastBackupKey = 'barbapro_last_backup';
      }

      // Simula backup no Google Drive usando localStorage como exemplo
      async fazerBackup(dados) {
        try {
          // Em um ambiente real, aqui seria a integraÃ§Ã£o com Google Drive API
          // Por enquanto, vamos usar localStorage para simular
          const backupData = {
            ...dados,
            backupTimestamp: new Date().toISOString(),
            backupId: this.gerarIdBackup()
          };

          localStorage.setItem(this.backupKey, JSON.stringify(backupData));
          localStorage.setItem(this.lastBackupKey, new Date().toISOString());
          
          this.mostrarStatusBackup('success', 'Dados salvos com sucesso!');
          return true;
        } catch (error) {
          console.error('Erro no backup:', error);
          this.mostrarStatusBackup('error', 'Erro ao salvar dados');
          return false;
        }
      }

      async restaurarBackup() {
        try {
          const backupData = localStorage.getItem(this.backupKey);
          if (!backupData) {
            return null;
          }

          const dados = JSON.parse(backupData);
          this.mostrarStatusBackup('success', 'Dados restaurados com sucesso!');
          return dados;
        } catch (error) {
          console.error('Erro ao restaurar backup:', error);
          this.mostrarStatusBackup('error', 'Erro ao restaurar dados');
          return null;
        }
      }

      mostrarStatusBackup(tipo, mensagem) {
        const elemento = document.getElementById('backupStatus');
        elemento.textContent = mensagem;
        elemento.className = `backup-status backup-${tipo}`;
        elemento.style.display = 'block';
        
        setTimeout(() => {
          elemento.style.display = 'none';
        }, 3000);
      }

      gerarIdBackup() {
        return 'backup_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      getUltimoBackup() {
        return localStorage.getItem(this.lastBackupKey);
      }
    }

    // === BANCO DE DADOS LOCAL ===
    class BarbaPRODatabase {
      constructor() {
        this.dbName = 'BarbaPRO_DB';
        this.version = 4; // Aumentei a versÃ£o para forÃ§ar atualizaÃ§Ã£o
        this.db = null;
        this.backup = new DriveBackup();
        this.init();
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.version);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = async () => {
            this.db = request.result;
            
            // Tentar restaurar backup ao inicializar
            await this.restaurarDoBackup();
            resolve(this.db);
          };
          
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Criar store para cortes
            if (!db.objectStoreNames.contains('cortes')) {
              const cortesStore = db.createObjectStore('cortes', { keyPath: 'id', autoIncrement: true });
              cortesStore.createIndex('data', 'data', { unique: false });
              cortesStore.createIndex('mes', 'mes', { unique: false });
              cortesStore.createIndex('ano', 'ano', { unique: false });
              cortesStore.createIndex('dataCompleta', 'dataCompleta', { unique: false });
            }
            
            // Criar store para expedientes
            if (!db.objectStoreNames.contains('expedientes')) {
              const expedientesStore = db.createObjectStore('expedientes', { keyPath: 'id', autoIncrement: true });
              expedientesStore.createIndex('data', 'data', { unique: false });
              expedientesStore.createIndex('mes', 'mes', { unique: false });
            }

            // Criar store para configuraÃ§Ãµes
            if (!db.objectStoreNames.contains('configuracoes')) {
              const configStore = db.createObjectStore('configuracoes', { keyPath: 'chave' });
            }
          };
        });
      }

      async restaurarDoBackup() {
        const backupData = await this.backup.restaurarBackup();
        if (backupData && backupData.cortes) {
          console.log('Restaurando dados do backup...');
          // Aqui implementaria a lÃ³gica para restaurar os dados do backup
        }
      }

      async fazerBackupCompleto() {
        const cortes = await this.getAll('cortes');
        const expedientes = await this.getAll('expedientes');
        const configuracoes = await this.getAll('configuracoes');
        
        const dadosBackup = {
          cortes,
          expedientes,
          configuracoes,
          timestamp: new Date().toISOString()
        };

        return await this.backup.fazerBackup(dadosBackup);
      }

      async add(storeName, data) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([storeName], 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.add(data);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = async () => {
            // Fazer backup apÃ³s cada operaÃ§Ã£o importante
            if (storeName === 'cortes' || storeName === 'expedientes') {
              await this.fazerBackupCompleto();
            }
            resolve(request.result);
          };
        });
      }

      async getAll(storeName) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([storeName], 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.getAll();
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);
        });
      }

      async get(storeName, key) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([storeName], 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.get(key);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);
        });
      }

      async put(storeName, data) {
        return new Promise((resolve, reject) => {
          const transaction = this.db.transaction([storeName], 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.put(data);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = async () => {
            await this.fazerBackupCompleto();
            resolve(request.result);
          };
        });
      }

      async delete(storeName, id) {
        return new Promise((resolve, reject) => {
          if (!id) {
            reject(new Error('ID nÃ£o especificado para deletar'));
            return;
          }
          
          const transaction = this.db.transaction([storeName], 'readwrite');
          const store = transaction.objectStore(storeName);
          const request = store.delete(id);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = async () => {
            await this.fazerBackupCompleto();
            resolve(request.result);
          };
        });
      }
    }

    // === INICIALIZAÃ‡ÃƒO DO APP ===
    let database;
    let cortes = [];
    let expedientes = [];
    let valorCortePadrao = 20;
    let expedienteAberto = true;

    async function initApp() {
      try {
        database = new BarbaPRODatabase();
        await database.init();
        
        // Carregar dados
        cortes = await database.getAll('cortes');
        expedientes = await database.getAll('expedientes');
        
        // Carregar configuraÃ§Ãµes
        const configValor = await database.get('configuracoes', 'valorCorte');
        if (configValor) {
          valorCortePadrao = configValor.valor;
        }

        // SEMPRE comeÃ§a com expediente aberto, independente do que estava salvo
        expedienteAberto = true;
        await database.put('configuracoes', { chave: 'expedienteAberto', aberto: true });

        // Ordenar cortes por data (mais recente primeiro)
        cortes.sort((a, b) => new Date(b.data) - new Date(a.data));
        
        atualizar();
        verificarExpediente();
        console.log('BarbaPRO inicializado com sucesso!');
      } catch (error) {
        console.error('Erro ao inicializar:', error);
        alert('Erro ao carregar dados. Verifique o console.');
      }
    }

    // === FUNÃ‡Ã•ES DO APP ===
    function ripple(e) {
      const btn = e.currentTarget;
      const circle = document.createElement("span");
      const diameter = Math.max(btn.clientWidth, btn.clientHeight);
      const radius = diameter / 2;
      const rect = btn.getBoundingClientRect();
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${(e.touches ? e.touches[0].clientX : e.clientX) - rect.left - radius}px`;
      circle.style.top  = `${(e.touches ? e.touches[0].clientY : e.clientY) - rect.top  - radius}px`;
      circle.classList.add("ripple");
      btn.appendChild(circle);
      setTimeout(() => circle.remove(), 600);
    }

    document.querySelectorAll('.btn').forEach(b => {
      b.addEventListener('touchstart', ripple, {passive:true});
      b.addEventListener('click', ripple);
    });

    function verificarExpediente() {
      // AGORA: Sempre verifica o estado atual em tempo real
      if (expedienteAberto) {
        document.getElementById('statusExpediente').style.display = 'none';
        document.getElementById('botoesPrincipais').style.display = 'block';
      } else {
        document.getElementById('statusExpediente').style.display = 'block';
        document.getElementById('botoesPrincipais').style.display = 'none';
        
        const hoje = new Date().toLocaleDateString('pt-BR');
        const info = `
          Expediente fechado temporariamente<br>
          Clique em "ABRIR EXPEDIENTE" para continuar<br>
          Data: ${hoje}
        `;
        document.getElementById('infoExpediente').innerHTML = info;
      }
    }

    async function abrirExpediente() {
      // SIMPLESMENTE muda o estado para aberto
      expedienteAberto = true;
      await database.put('configuracoes', { chave: 'expedienteAberto', aberto: true });
      verificarExpediente();
      vibra();
      console.log('Expediente aberto - pode adicionar cortes novamente');
    }

    async function cortePadrao() {
      if (!expedienteAberto) {
        alert('Expediente estÃ¡ fechado! Abra o expediente para adicionar cortes.');
        return;
      }

      const hoje = new Date();
      const corte = {
        data: hoje,
        dataCompleta: hoje.toLocaleDateString('pt-BR'),
        valor: valorCortePadrao,
        cliente: 'Cliente',
        pago: true,
        mes: hoje.getMonth(),
        ano: hoje.getFullYear()
      };
      
      try {
        await database.add('cortes', corte);
        cortes.unshift(corte);
        atualizar();
        vibra();
      } catch (error) {
        console.error('Erro ao salvar corte:', error);
        alert('Erro ao salvar corte. Tente novamente.');
      }
    }

    function editarValorCorte() {
      document.getElementById('novoValorCorte').value = valorCortePadrao;
      document.getElementById('modalEditarValor').style.display = 'flex';
    }

    async function salvarNovoValor() {
      const novoValor = parseFloat(document.getElementById('novoValorCorte').value) || 20;
      
      if (novoValor <= 0) {
        alert('Por favor, insira um valor vÃ¡lido.');
        return;
      }

      valorCortePadrao = novoValor;
      document.getElementById('valorCorte').textContent = novoValor.toFixed(0);
      
      try {
        await database.put('configuracoes', { 
          chave: 'valorCorte', 
          valor: novoValor 
        });
        fecharModalEditarValor();
        vibra();
      } catch (error) {
        console.error('Erro ao salvar valor:', error);
        alert('Erro ao salvar valor. Tente novamente.');
      }
    }

    function fecharModalEditarValor() {
      document.getElementById('modalEditarValor').style.display = 'none';
    }

    function cortePersonalizado() { 
      if (!expedienteAberto) {
        alert('Expediente estÃ¡ fechado! Abra o expediente para adicionar cortes.');
        return;
      }
      hideAll(); 
      document.getElementById('formCorte').style.display='block'; 
    }
    
    function hideAll() { 
      document.querySelectorAll('#formCorte').forEach(f=>f.style.display='none'); 
    }
    
    function cancelar() { 
      hideAll(); 
    }

    async function salvarCorte() {
      const v = parseFloat(document.getElementById('valorCustom').value) || valorCortePadrao;
      const c = document.getElementById('cliente').value || 'Cliente';
      const p = document.getElementById('pago').value == '1';
      
      if (v <= 0) {
        alert('Por favor, insira um valor vÃ¡lido para o corte.');
        return;
      }
      
      const hoje = new Date();
      const corte = {
        data: hoje,
        dataCompleta: hoje.toLocaleDateString('pt-BR'),
        valor: v,
        cliente: c,
        pago: p,
        mes: hoje.getMonth(),
        ano: hoje.getFullYear()
      };
      
      try {
        await database.add('cortes', corte);
        cortes.unshift(corte);
        document.getElementById('valorCustom').value = '';
        document.getElementById('cliente').value = '';
        hideAll(); 
        atualizar(); 
        vibra();
      } catch (error) {
        console.error('Erro ao salvar corte:', error);
        alert('Erro ao salvar corte. Tente novamente.');
      }
    }

    async function apagarEsse(id) {
      if (confirm('Apagar esse corte?')) {
        try {
          await database.delete('cortes', id);
          cortes = cortes.filter(x => x.id !== id);
          atualizar(); 
          vibra();
        } catch (error) {
          console.error('Erro ao apagar corte:', error);
          alert('Erro ao apagar corte. Tente novamente.');
        }
      }
    }
    
    function vibra() { 
      navigator.vibrate?.(50); 
    }

    async function finalizarExpediente() {
      // AGORA: SÃ³ fecha temporariamente, sem criar registro permanente
      expedienteAberto = false;
      await database.put('configuracoes', { chave: 'expedienteAberto', aberto: false });
      
      verificarExpediente();
      vibra();
      
      // Mostra mensagem informativa
      alert('Expediente fechado temporariamente. VocÃª pode reabrir quando quiser continuar!');
    }

    function mostrarResumoCompleto() {
      document.getElementById('modalResumo').style.display = 'flex';
      atualizarResumoCompleto();
    }

    function atualizarResumoCompleto() {
      const hoje = new Date();
      const hojeStr = hoje.toLocaleDateString('pt-BR');
      
      let totalHoje = 0, fiadoHoje = 0, cortesHoje = 0;
      let totalSemana = 0, cortesSemana = 0;
      let totalMes = 0, cortesMes = 0;

      // Uma semana atrÃ¡s
      const umaSemanaAtras = new Date();
      umaSemanaAtras.setDate(hoje.getDate() - 7);

      cortes.forEach(c => {
        const dataCorte = new Date(c.data);
        
        // Hoje
        if (dataCorte.toLocaleDateString('pt-BR') === hojeStr) {
          totalHoje += c.valor;
          cortesHoje++;
          if (!c.pago) fiadoHoje += c.valor;
        }
        
        // Esta semana
        if (dataCorte >= umaSemanaAtras) {
          totalSemana += c.valor;
          cortesSemana++;
        }
        
        // Este mÃªs
        if (dataCorte.getMonth() === hoje.getMonth() && 
            dataCorte.getFullYear() === hoje.getFullYear()) {
          totalMes += c.valor;
          cortesMes++;
        }
      });

      const html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">HOJE</div>
            <div class="stat-value hoje">R$ ${totalHoje.toFixed(2)}</div>
            <div class="stat-label">${cortesHoje} cortes</div>
            <div class="stat-label">Fiado: R$ ${fiadoHoje.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ESTA SEMANA</div>
            <div class="stat-value semana">R$ ${totalSemana.toFixed(2)}</div>
            <div class="stat-label">${cortesSemana} cortes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ESTE MÃŠS</div>
            <div class="stat-value mes">R$ ${totalMes.toFixed(2)}</div>
            <div class="stat-label">${cortesMes} cortes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">VALOR ATUAL</div>
            <div class="stat-value">R$ ${valorCortePadrao.toFixed(2)}</div>
            <div class="stat-label">por corte</div>
          </div>
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <div class="lucro">TOTAL MENSAL: R$ ${totalMes.toFixed(2)}</div>
          <div style="color: #aaa; margin-top: 10px;">
            Ãšltima atualizaÃ§Ã£o: ${new Date().toLocaleTimeString('pt-BR')}
          </div>
        </div>
      `;

      document.getElementById('resumoCompleto').innerHTML = html;
    }

    function fecharModal() {
      document.getElementById('modalResumo').style.display = 'none';
    }

    // === ATUALIZA TELA PRINCIPAL ===
    function atualizar() {
      const hoje = new Date().toLocaleDateString('pt-BR');
      let html = '';
      let totalDia = 0, fiadoDia = 0;
      let cortesHoje = 0;

      // Filtrar cortes de hoje
      const cortesHojeList = cortes.filter(x => 
        new Date(x.data).toLocaleDateString('pt-BR') === hoje
      );

      cortesHoje = cortesHojeList.length;
      
      // Calcular totais
      cortesHojeList.forEach(x => {
        totalDia += x.valor;
        if (!x.pago) fiadoDia += x.valor;
      });

      // Se nÃ£o hÃ¡ cortes hoje, mostrar estado vazio
      if (cortesHoje === 0) {
        html = `
          <div class="empty-state">
            <p>Nenhum corte registrado hoje</p>
            <p style="font-size: 4vw; margin-top: 10px;">Use os botÃµes acima para adicionar cortes</p>
          </div>
        `;
      } else {
        // Mostrar tabela com cortes de hoje
        html = `<table>
          <tr>
            <th>Hora</th>
            <th>Cliente</th>
            <th>Valor</th>
            <th>Status</th>
            <th>AÃ§Ã£o</th>
          </tr>`;
        
        cortesHojeList.forEach(x => {
          const hora = new Date(x.data).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
          html += `<tr class="${x.pago?'pago':'fiado'}">
            <td>${hora}</td>
            <td>${x.cliente}</td>
            <td>R$ ${x.valor.toFixed(2)}</td>
            <td>${x.pago?'PAGO':'FIADO'}</td>
            <td>
              <button class="action-btn delete-btn" onclick="apagarEsse(${x.id})">X</button>
            </td>
          </tr>`;
        });
        html += `</table>`;
      }
      
      document.getElementById('lista').innerHTML = html;

      // Atualizar valor do corte no botÃ£o
      document.getElementById('valorCorte').textContent = valorCortePadrao.toFixed(0);

      // RESUMO MÃŠS
      const mes = new Date().getMonth();
      const ano = new Date().getFullYear();
      let totalMes = 0;
      
      cortes.forEach(x => { 
        if (new Date(x.data).getMonth() === mes && new Date(x.data).getFullYear() === ano) 
          totalMes += x.valor; 
      });

      document.getElementById('resumo').innerHTML = `
        <h3 class="section-title">Resumo do Dia</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">HOJE</div>
            <div class="stat-value hoje">R$ ${totalDia.toFixed(2)}</div>
            <div class="stat-label">${cortesHoje} cortes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">FIADO</div>
            <div class="stat-value">R$ ${fiadoDia.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ESTE MÃŠS</div>
            <div class="stat-value mes">R$ ${totalMes.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">VALOR</div>
            <div class="stat-value">R$ ${valorCortePadrao.toFixed(2)}</div>
            <div class="stat-label">por corte</div>
          </div>
        </div>
      `;
    }

    // INICIALIZAR APP
    initApp();
  </script>
</body>
</html>